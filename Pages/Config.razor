@page "/config"
@inject IJSRuntime JS
@implements IDisposable


@using EarWorm.Code;
@inject SavedData _saver
@inject MusicEngine _musicEngine

<PageTitle>Configure</PageTitle>
<DropDown Items=@Items ButtonText="Select Instrument" Selected=@Selected
OnSelectionChange=@InstrumentChanged/>

<HxInputCheckbox @bind-Value="SleepChecked" Label="Prevent Device Sleeping While Playing" />

@code {

    Dictionary<string, Instrument> _instrumentTable;
    List<string> _instrumentKeys;
    List<string> _instrumentNames;
    public Config()
    {
        _instrumentTable = Lookups.Instruments;
        _instrumentKeys = _instrumentTable.Keys.ToList();
        _instrumentNames = _instrumentTable.Values.Select(ins=>ins.Name).ToList();
        //SleepChecked = !_saver.Settings.NoSleep;
    }

    public bool SleepChecked{ get {
            return !_saver.Settings.NoSleep;
        }
        set {
            _saver.Settings.NoSleep = !value;
        } }
    public List<string> Items { get
        {
            return _instrumentNames;
        } }
    public int Selected
    {
        get
        {
            var sel = _musicEngine.GetCurrentInstrument();
            return _instrumentKeys.FindIndex(x => x == sel.Key);
        }
    }
    private void Play()
    {
        var notes = new string[]{ "c4", "e4", "g5"};
        JS.InvokeVoidAsync("playChord",notes,0);
    }

    private void InstrumentChanged(int value)
    {
        Util.Log($"inst = {value}");
        var k = _instrumentKeys[value];
        _saver.Settings.InstrumentKey = k;
    }
    public void Dispose() {
        Util.Log("displose config");
        _saver.SaveSettings();
        _saver.SaveSetDefs();
    }
}


